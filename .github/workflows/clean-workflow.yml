name: Cleanup Workflow Runs
on:
  schedule:
    - cron: '0 0 * * 0' # æ¯å‘¨æ—¥0ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      keep_days:
        description: "ä¿ç•™æœ€è¿‘å¤šå°‘å¤©ï¼ˆ0=å…¨éƒ¨æ¸…ç†ï¼Œé»˜è®¤0ï¼‰"
        required: false
        default: "0"
      repositories:
        description: "è¦æ¸…ç†çš„ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºä¸ºå½“å‰ä»“åº“ï¼Œè¾“å…¥ 'all' æ¸…ç†æ‰€æœ‰ä»“åº“ï¼‰"
        required: false
        default: ""

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: è®¾ç½®ç›®æ ‡ä»“åº“åˆ—è¡¨
        id: set-repos
        run: |
          if [ -z "${{ github.event.inputs.repositories }}" ]; then
            REPOS="${{ github.repository }}"
            MODE="current"
          elif [ "${{ github.event.inputs.repositories }}" = "all" ]; then
            REPOS="all"
            MODE="all"
          else
            REPOS="${{ github.event.inputs.repositories }}"
            MODE="manual"
          fi
        
          REPOS=$(echo "$REPOS" | tr -d ' ' | sed 's/,,*/,/g' | sed 's/^,//' | sed 's/,$//')
        
          echo "repositories=$REPOS" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "ğŸ” æ¨¡å¼ï¼š$MODEï¼Œå°†æ¸…ç†ä»“åº“ï¼š$REPOS"

      - name: è·å–æ‰€æœ‰ä»“åº“åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯allæ¨¡å¼ï¼‰
        if: steps.set-repos.outputs.mode == 'all'
        id: get-all-repos
        run: |
          echo "ğŸ” æ­£åœ¨è·å–æ‚¨æœ‰æƒé™çš„æ‰€æœ‰ä»“åº“..."
         
          page=1
          ALL_REPOS=""
         
          while true; do
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
                          "https://api.github.com/user/repos?per_page=100&page=$page&affiliation=owner,collaborator,organization_member&sort=full_name")
           
            REPOS_PAGE=$(echo "$RESPONSE" | jq -r '.[].full_name' | tr '\n' ',')
           
            if [ -z "$REPOS_PAGE" ] || [ "$REPOS_PAGE" = "" ]; then
              break
            fi
           
            ALL_REPOS="${ALL_REPOS}${REPOS_PAGE}"
            page=$((page + 1))
           
            TOTAL_PROCESSED=$(( (page-1) * 100 ))
            echo "ğŸ“Š å·²è·å– $TOTAL_PROCESSED ä¸ªä»“åº“..."
           
            if [ $page -gt 20 ]; then
              echo "âš ï¸ æ³¨æ„ï¼šå·²è·å– 2000 ä¸ªä»“åº“ï¼Œå¦‚éœ€æ›´å¤šè¯·è°ƒæ•´ page é™åˆ¶"
              break
            fi
           
            sleep 0.5
          done
         
          ALL_REPOS=${ALL_REPOS%,}
          REPO_COUNT=$(echo "$ALL_REPOS" | tr ',' '\n' | wc -l)
         
          echo "repositories=$ALL_REPOS" >> $GITHUB_OUTPUT
          echo "ğŸ” å…±æ‰¾åˆ° $REPO_COUNT ä¸ªä»“åº“"

      - name: è¿‡æ»¤æœ‰workflowæ–‡ä»¶çš„ä»“åº“ï¼ˆå®‰å…¨ç‰ˆï¼‰
        if: steps.set-repos.outputs.mode == 'all'
        id: filter-workflow-repos
        run: |
          echo "ğŸ” è¿‡æ»¤æœ‰ .github/workflows/ æ–‡ä»¶çš„ä»“åº“ï¼ˆå®‰å…¨ç‰ˆï¼‰..."
         
          # åˆå§‹åŒ–å˜é‡
          IFS=',' read -ra ALL_REPOS <<< "${{ steps.get-all-repos.outputs.repositories }}"
          ACTIVE_REPOS=""
          CHECKED_COUNT=0
          TOTAL_TO_CHECK=${#ALL_REPOS[@]}
         
          echo "ğŸ“Š æ€»å…±éœ€è¦æ£€æŸ¥ $TOTAL_TO_CHECK ä¸ªä»“åº“"
         
          # è®¾ç½®é”™è¯¯å¤„ç† - å³ä½¿å•ä¸ªä»“åº“æ£€æŸ¥å¤±è´¥ï¼Œä¹Ÿä¸é€€å‡ºæ•´ä¸ªè„šæœ¬
          set +e
          trap 'echo "å¤„ç†ä»“åº“æ—¶å‘ç”Ÿé”™è¯¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª..."' ERR
         
          for REPO in "${ALL_REPOS[@]}"; do
            ((CHECKED_COUNT++))
           
            if (( CHECKED_COUNT % 10 == 0 )); then
              echo "ğŸ“Š æ­£åœ¨æ£€æŸ¥ä»“åº“ $CHECKED_COUNT/$TOTAL_TO_CHECK..."
            fi
           
            HAS_WORKFLOW=0
           
            # ç®€åŒ–æ£€æŸ¥é€»è¾‘ - ç›´æ¥æ£€æŸ¥æ˜¯å¦æœ‰workflowsç›®å½•ï¼Œä¸å…³å¿ƒå…·ä½“åˆ†æ”¯
            WORKFLOWS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
                              "https://api.github.com/repos/$REPO/contents/.github/workflows")
           
            # æ£€æŸ¥å“åº”æ˜¯å¦æ˜¯æ•°ç»„ï¼ˆç›®å½•æœ‰å†…å®¹ï¼‰æˆ–å¯¹è±¡ï¼ˆç©ºç›®å½•ï¼‰
            if echo "$WORKFLOWS_RESPONSE" | jq -e '.type == "dir" or type == "array"' >/dev/null 2>&1; then
              HAS_WORKFLOW=1
            else
              # å¦‚æœä¸»åˆ†æ”¯æ²¡æœ‰ï¼Œå°è¯•å¸¸è§åˆ†æ”¯
              for BRANCH in main master; do
                WORKFLOWS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
                                  "https://api.github.com/repos/$REPO/contents/.github/workflows?ref=$BRANCH" 2>/dev/null || echo "{}")
               
                if echo "$WORKFLOWS_RESPONSE" | jq -e '.type == "dir" or type == "array"' >/dev/null 2>&1; then
                  HAS_WORKFLOW=1
                  break
                fi
              done
            fi
           
            if [ "$HAS_WORKFLOW" -eq 1 ]; then
              ACTIVE_REPOS="${ACTIVE_REPOS}${REPO},"
              echo " âœ… $REPO æœ‰ workflow æ–‡ä»¶"
            else
              echo " â­ï¸ $REPO æ—  workflow æ–‡ä»¶ï¼Œè·³è¿‡"
            fi
           
            sleep 0.2
          done
         
          # æ¢å¤é”™è¯¯å¤„ç†
          set -e
          trap - ERR
         
          ACTIVE_REPOS=${ACTIVE_REPOS%,}
          ACTIVE_COUNT=0
          if [ -n "$ACTIVE_REPOS" ]; then
            ACTIVE_COUNT=$(echo "$ACTIVE_REPOS" | tr ',' '\n' | wc -l)
          fi
         
          echo "ğŸ“Š åœ¨ $CHECKED_COUNT ä¸ªä»“åº“ä¸­ï¼Œ$ACTIVE_COUNT ä¸ªåŒ…å« workflow æ–‡ä»¶"
         
          if [ -n "$ACTIVE_REPOS" ] && [ "$ACTIVE_COUNT" -gt 0 ]; then
            echo "ä½¿ç”¨è¿‡æ»¤åçš„ä»“åº“åˆ—è¡¨ï¼ˆæœ‰workflowæ–‡ä»¶çš„ï¼‰"
            echo "repositories=$ACTIVE_REPOS" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ è¿‡æ»¤åæ²¡æœ‰å‘ç°åŒ…å«workflowæ–‡ä»¶çš„ä»“åº“ï¼Œä½¿ç”¨åŸå§‹åˆ—è¡¨"
            echo "repositories=${{ steps.get-all-repos.outputs.repositories }}" >> $GITHUB_OUTPUT
          fi

      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œ
        env:
          KEEP_DAYS: ${{ github.event.inputs.keep_days }}
          REPOSITORIES: ${{ steps.set-repos.outputs.mode == 'all' && (steps.filter-workflow-repos.outputs.repositories || steps.get-all-repos.outputs.repositories) || steps.set-repos.outputs.repositories }}
          GH_TOKEN: ${{ secrets.AUTH_PAT }}
        run: |
          : "${KEEP_DAYS:=0}"
        
          echo "å‚æ•°é…ç½®ï¼š"
          echo " - ä¿ç•™å¤©æ•°: $KEEP_DAYS (0=å…¨éƒ¨æ¸…ç†)"
          echo " - ç›®æ ‡ä»“åº“æ•°é‡: $(echo "$REPOSITORIES" | tr ',' '\n' | wc -l) ä¸ª"
        
          if [ -z "$REPOSITORIES" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè¦æ¸…ç†çš„ä»“åº“"
            exit 1
          fi
        
          IFS=',' read -ra REPO_ARRAY <<< "$REPOSITORIES"
        
          BATCH_SIZE=10
          TOTAL_REPOS=${#REPO_ARRAY[@]}
          CURRENT_INDEX=0
        
          for TARGET_REPO in "${REPO_ARRAY[@]}"; do
            CURRENT_INDEX=$((CURRENT_INDEX + 1))
           
            if (( CURRENT_INDEX % BATCH_SIZE == 0 )) || (( CURRENT_INDEX == TOTAL_REPOS )); then
              echo ""
              echo "ğŸ“ˆ è¿›åº¦: $CURRENT_INDEX/$TOTAL_REPOS ä¸ªä»“åº“"
            fi
           
            echo ""
            echo "========================================"
            echo "ğŸ¯ å¼€å§‹æ¸…ç†ä»“åº“ ($CURRENT_INDEX/$TOTAL_REPOS): $TARGET_REPO"
            echo "========================================"
          
            JQ_FILTER='.workflow_runs[] | select(.status=="completed")'
          
            if [ "$KEEP_DAYS" -gt 0 ]; then
              THRESHOLD=$(date -u -d "${KEEP_DAYS} days ago" '+%Y-%m-%dT%H:%M:%SZ')
              echo "ğŸ“… ä¿ç•™æœ€è¿‘ $KEEP_DAYS å¤©çš„è¿è¡Œè®°å½•"
              echo "â° é˜ˆå€¼æ—¶é—´(UTC)ï¼š$THRESHOLD"
              JQ_FILTER="$JQ_FILTER | select(.created_at < \"$THRESHOLD\")"
            else
              echo "âš ï¸ è­¦å‘Šï¼šå°†æ¸…ç†æ‰€æœ‰å·²å®Œæˆçš„å·¥ä½œæµè¿è¡Œ"
            fi
          
            TOTAL_DELETED=0
            TOTAL_FAILED=0
            page=1
          
            while true; do
              echo "ğŸ“„ æ­£åœ¨è·å–ç¬¬ $page é¡µ..."
            
              RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
                            "https://api.github.com/repos/$TARGET_REPO/actions/runs?per_page=100&page=$page")
            
              if ! echo "$RESPONSE" | jq -e '.workflow_runs' > /dev/null 2>&1; then
                ERROR_MSG=$(echo "$RESPONSE" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')
                if [ "$ERROR_MSG" = "Bad credentials" ]; then
                  echo "âŒ èº«ä»½éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ AUTH_PAT æ˜¯å¦æœ‰æ•ˆ"
                  break
                elif [ "$ERROR_MSG" = "Not Found" ]; then
                  echo "âŒ ä»“åº“ '$TARGET_REPO' ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
                  break
                else
                  echo "âŒ API å“åº”å¼‚å¸¸ï¼š$ERROR_MSG"
                  break
                fi
              fi
            
              RUN_IDS=$(echo "$RESPONSE" | jq -r "$JQ_FILTER | .id" | tr '\n' ' ')
            
              if [ -z "$RUN_IDS" ] || [ "$RUN_IDS" = " " ]; then
                echo "âœ… ç¬¬ $page é¡µæ²¡æœ‰å¯åˆ é™¤çš„è¿è¡Œ"
                TOTAL_COUNT=$(echo "$RESPONSE" | jq '.total_count // 0')
                TOTAL_PROCESSED=$(( (page-1) * 100 ))
                if [ $TOTAL_PROCESSED -ge $TOTAL_COUNT ]; then
                  echo "ğŸ“Š å·²å¤„ç†å®Œæ‰€æœ‰ $TOTAL_COUNT ä¸ªè®°å½•"
                  break
                fi
              else
                RUN_IDS=$(echo "$RUN_IDS" | xargs)
                COUNT=$(echo "$RUN_IDS" | wc -w)
                echo "ğŸ—‘ï¸ ç¬¬ $page é¡µå‘ç° $COUNT ä¸ªå¾…åˆ é™¤è¿è¡Œ"
              
                for RUN_ID in $RUN_IDS; do
                  echo " åˆ é™¤è¿è¡Œ ID: $RUN_ID"
                
                  DELETE_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                    -H "Authorization: token $GH_TOKEN" \
                    "https://api.github.com/repos/$TARGET_REPO/actions/runs/$RUN_ID")
                
                  if [ "$DELETE_RESPONSE" = "204" ]; then
                    echo " âœ… åˆ é™¤æˆåŠŸ"
                    TOTAL_DELETED=$((TOTAL_DELETED + 1))
                  else
                    echo " âŒ åˆ é™¤å¤±è´¥ (HTTP $DELETE_RESPONSE)"
                    TOTAL_FAILED=$((TOTAL_FAILED + 1))
                  fi
                
                  sleep 0.2
                done
              
                echo "ğŸ“Š ç¬¬ $page é¡µå®Œæˆ"
              fi
            
              page=$((page + 1))
            done
          
            echo ""
            echo "âœ… ä»“åº“ $TARGET_REPO æ¸…ç†å®Œæˆ"
            echo "ğŸ“ˆ ç»Ÿè®¡ï¼šæˆåŠŸåˆ é™¤ $TOTAL_DELETED ä¸ªè¿è¡Œï¼Œå¤±è´¥ $TOTAL_FAILED ä¸ª"
            echo ""
          done
        
          echo "ğŸ‰ æ‰€æœ‰æŒ‡å®šä»“åº“æ¸…ç†å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ æœ€ç»ˆç»Ÿè®¡ï¼š"
          echo " æ€»å…±å¤„ç†ä»“åº“æ•°: $TOTAL_REPOS"
          echo " æ¨¡å¼: ${{ steps.set-repos.outputs.mode }}"

# ========================================
# é…ç½®è¯´æ˜ï¼š
# 1. åˆ›å»º Personal Access Token (PAT)ï¼š
#    - è®¿é—® GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens
#    - ç”Ÿæˆ tokenï¼Œè‡³å°‘é€‰æ‹©æƒé™ï¼šrepo (å®Œå…¨è®¿é—®ä»“åº“)ã€workflow (è¯»å†™å·¥ä½œæµ)
#    
# 2. å°† PAT æ·»åŠ åˆ°ä»“åº“ Secretsï¼š
#    - è¿›å…¥ä»“åº“ â†’ Settings â†’ Secrets and variables â†’ Actions
#    - æ–°å»º Secretï¼Œåç§°ï¼šAUTH_PATï¼Œå€¼ï¼šç²˜è´´åˆšæ‰å¤åˆ¶çš„ token
#    
# 3. ä½¿ç”¨è¯´æ˜ï¼š
#    - å®šæ—¶ä»»åŠ¡ï¼šæ¯å‘¨æ—¥0ç‚¹è‡ªåŠ¨è¿è¡Œï¼Œé»˜è®¤æ¸…ç†æ‰€æœ‰å·²å®Œæˆè¿è¡Œ
#    - æ‰‹åŠ¨è§¦å‘ï¼šå¯æŒ‡å®šä¿ç•™å¤©æ•°(0=å…¨éƒ¨æ¸…ç†)å’Œä»“åº“åˆ—è¡¨(é€—å·åˆ†éš”)
#    - ç¤ºä¾‹ï¼šrepositories: user/repo1,user/repo2ï¼Œkeep_days: 7
#    - all = è‡ªåŠ¨è·å–å¹¶æ¸…ç†æ‰€æœ‰æœ‰æƒé™çš„ä»“åº“ï¼ˆæ¨èç”¨äºæ‰¹é‡ç®¡ç†ï¼‰
#
# 4. ä½¿ç”¨ AUTH_PAT - å¯ä»¥ç›´æ¥å¤åˆ¶åˆ°ä»»ä½•ä»“åº“
#    secrets.AUTH_PAT
#    ä½¿ç”¨ GITHUB_TOKEN - ä»…é™å½“å‰ä»“åº“ï¼Œæ— è·¨é¡¹ç›®æƒé™ï¼Œæ˜¯ GitHub Actions è¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆçš„ä¸´æ—¶ token
#    secrets.GITHUB_TOKEN
# ========================================
